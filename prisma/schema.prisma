// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================================================
//  AUTHENTICATION & TENANT MANAGEMENT
// =========================================================

model User {
  id            String   @id @default(uuid()) @db.Uuid
  email         String   @unique
  password      String
  displayName   String?
  photoURL      String?
  provider      String?  @default("email")
  providerId    String?
  emailVerified Boolean? @default(false)
  role          UserRole @default(USER)
  createdAt     DateTime @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @db.Timestamptz(6)
  tenants       Tenant[]
  pushTokens    PushNotificationToken[]
  hunter        Hunter?

  @@unique([provider, providerId])
}

model Tenant {
  id                          String                      @id @default(uuid()) @db.Uuid
  userId                      String                      @map("user_id") @db.Uuid
  name                        String
  email                       String                      @unique
  address                     String?
  phone                       String?
  subscribedUntil             DateTime?                   @map("subscribed_until") @db.Timestamptz(6)
  isSubscribed                Boolean?                    @default(false) @map("is_subscribed")
  hunterReferralCode          String?                     @map("hunter_referral_code") // Hunter referral code used during registration
  createdAt                   DateTime                    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                   DateTime                    @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  user                        User                        @relation(fields: [userId], references: [id])
  hunter                      Hunter?                     @relation(fields: [hunterReferralCode], references: [referralCode])
  customers                   Customer[]
  discounts                   Discount[]
  expenseCategories           ExpenseCategory[]
  expenses                    Expense[]
  logs                        Log[]
  orders                      Order[]
  orderItems                  OrderItem[]
  products                    Product[]
  productCategories           ProductCategory[]
  staffs                      Staff[]
  settings                    TenantSetting?
  subscription                TenantSubscription?
  subscriptionPayments        SubscriptionPayment[]
  tenantSubscriptionHistories TenantSubscriptionHistory[]

  orderStatuses              OrderStatus[]

  // Relasi Penggajian
  payrollSettings PayrollSetting?
  salaries        Salary[]
  attendances     Attendance[]
  payrollPeriods  PayrollPeriod[]
  payrollDetails  PayrollDetail[]

  // Relasi Notifikasi
  notificationConfig    TenantNotificationConfig?
  notificationTemplates NotificationTemplate[]
  notificationLogs      NotificationLog[]

  // Relasi Laporan
  reports TenantReport[]
  reportsV2 Report[]

  // Relasi Shift Management
  shifts      Shift[]
  staffShifts StaffShift[]
  
  // Relasi Donation
  donations   TenantDonation[]

  // Relasi Push Notification
  pushTokens         PushNotificationToken[]
  pushMessages       PushNotificationMessage[]
  pushSubscriptions  PushNotificationSubscription[]

  @@index([userId])
}

model Staff {
  id          String       @id @default(uuid()) @db.Uuid
  tenantId    String?      @map("tenant_id") @db.Uuid
  isOwner     Boolean      @default(false)
  role        String
  username    String
  password    String
  createdAt   DateTime?    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime?    @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant      Tenant?      @relation(fields: [tenantId], references: [id])
  expenses    Expense[]
  logs        Log[]
  orders      Order[]
  orderLogs   OrderLog[]
  staffLeaves StaffLeave[]

  // Relasi Penggajian
  salary         Salary?
  attendances    Attendance[]
  payrollDetails PayrollDetail[]

  // Relasi Shift Management
  staffShifts    StaffShift[]

  // Relasi Push Notification
  pushTokens     PushNotificationToken[]

  @@unique([tenantId, username])
  @@index([tenantId])
}

enum AdminRole {
  SUPERADMIN
  ADMIN
  STAFF
}

enum UserRole {
  USER
  HUNTER
  ADMIN
}

model Admin {
  id          String    @id @default(uuid()) @db.Uuid
  role        AdminRole @default(ADMIN)
  username    String    @unique
  email       String    @unique
  fullName    String?
  password    String
  isActive    Boolean   @default(true)
  lastLoginAt DateTime? @map("last_login_at") @db.Timestamptz(6)
  createdAt   DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  hunters     Hunter[]

  @@index([email])
}

// =========================================================
//  BUSINESS OPERATIONS
// =========================================================

model Customer {
  id                  String    @id @default(uuid()) @db.Uuid
  tenantId            String?   @map("tenant_id") @db.Uuid
  membershipCode      String?   @unique @map("membership_code")
  name                String
  email               String?
  phone               String?
  address             String?
  birthday            DateTime? @db.Date
  lastPurchaseAt      DateTime? @map("last_purchase_at") @db.Timestamptz(6)
  membershipExpiredAt DateTime? @map("membership_expired_at") @db.Timestamptz(6)
  points              Int?      @default(0)
  createdAt           DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant              Tenant?   @relation(fields: [tenantId], references: [id])
  orders              Order[]

  @@index([tenantId])
  @@index([name])
  @@index([phone])
}

model Discount {
  id              String    @id @default(uuid()) @db.Uuid
  tenantId        String?   @map("tenant_id") @db.Uuid
  code            String?   @unique
  name            String
  description     String?
  type            String
  value           Decimal
  validFrom       DateTime? @map("valid_from") @db.Timestamptz(6)
  validTo         DateTime? @map("valid_to") @db.Timestamptz(6)
  minPurchase     Decimal?  @map("min_purchase")
  maxDiscount     Decimal?  @map("max_discount")
  applicableItems Json?     @map("applicable_items")
  rewardType      String?   @map("reward_type")
  isMemberOnly    Boolean?  @default(false) @map("is_member_only")
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant          Tenant?   @relation(fields: [tenantId], references: [id])
  orders          Order[]

  @@index([tenantId])
  @@index([validFrom])
  @@index([validTo])
}

model Order {
  id                     String      @id @default(uuid()) @db.Uuid
  tenantId               String?     @map("tenant_id") @db.Uuid
  orderNo                String      @unique @map("order_no")
  grandTotal             Decimal     @default(0) @map("grand_total")
  subtotal               Decimal     @map("subtotal")
  totalAmount            Decimal     @map("total_amount")
  paidAmount             Decimal     @map("paid_amount")
  remainingBalance       Decimal?    @map("remaining_balance")
  change                 Decimal?
  taxAmount              Decimal?    @map("tax_amount")
  paymentMethod          String?     @map("payment_method")
  paymentStatus          String?     @map("payment_status")
  orderStatus            String?     @map("order_status") @default("CONFIRMED")
  paymentDate            DateTime?   @map("payment_date") @db.Timestamptz(6)
  note                   String?     @default("")
  createdAt              DateTime?   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime?   @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  customerId             String?     @map("customer_id") @db.Uuid
  customerName           String?     @map("customer_name")
  discountId             String?     @map("discount_id") @db.Uuid
  discountName           String?     @map("discount_name")
  discountType           String?     @map("discount_type")
  discountValue          Decimal?    @map("discount_value")
  discountAmount         Decimal?    @map("discount_amount")
  discountRewardType     String?     @map("discount_reward_type")
  pointUsed              Int?        @map("point_used")
  staffId                String?     @map("staff_id") @db.Uuid
  lastPointsAccumulation Int?        @default(0) @map("last_points_accumulation")
  tenant                 Tenant?     @relation(fields: [tenantId], references: [id])
  customer               Customer?   @relation(fields: [customerId], references: [id])
  discount               Discount?   @relation(fields: [discountId], references: [id])
  staff                  Staff?      @relation(fields: [staffId], references: [id])
  items                  OrderItem[]
  orderLogs              OrderLog[]

  @@index([tenantId])
  @@index([createdAt])
  @@index([tenantId, createdAt])
  @@index([orderStatus])
  @@index([paymentStatus])
}

model OrderStatus {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  code      String
  name      String
  order     Int
  isFinal    Boolean  @default(false) @map("is_final")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  
  @@unique([tenantId, code])
  @@unique([tenantId, name])
  @@index([tenantId])
}

model OrderLog {
  id        String   @id @default(uuid()) @db.Uuid
  orderId   String   @map("order_id") @db.Uuid
  staffId   String?  @map("staff_id") @db.Uuid
  status    String
  note      String?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  order     Order    @relation(fields: [orderId], references: [id])
  staff     Staff?   @relation(fields: [staffId], references: [id])

  @@index([orderId])
  @@index([createdAt])
}

model OrderItem {
  id           String    @id @default(uuid()) @db.Uuid
  tenantId     String?   @map("tenant_id") @db.Uuid
  orderId      String?   @map("order_id") @db.Uuid
  productId    String?   @map("product_id") @db.Uuid
  productName  String    @map("product_name")
  productPrice Decimal   @map("product_price")
  qty          Decimal
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant       Tenant?   @relation(fields: [tenantId], references: [id])
  order        Order?    @relation(fields: [orderId], references: [id])
  product      Product?  @relation(fields: [productId], references: [id])

  @@index([tenantId])
  @@index([orderId])
  @@index([productId])
  @@index([createdAt])
}

model Product {
  id                String           @id @default(uuid()) @db.Uuid
  tenantId          String?          @map("tenant_id") @db.Uuid
  productCategoryId String?          @map("product_category_id") @db.Uuid
  name              String
  description       String?
  price             Decimal
  type              String
  stock             Int?
  sku               String?
  imageUrl          String?          @map("image_url")
  alias             String?
  isCountable       Boolean          @default(true) @map("is_countable")
  unit              String           @default("pcs")
  createdAt         DateTime?        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime?        @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant            Tenant?          @relation(fields: [tenantId], references: [id])
  productCategory   ProductCategory? @relation(fields: [productCategoryId], references: [id])
  orderItems        OrderItem[]

  @@index([tenantId])
  @@index([productCategoryId])
  @@index([name])
  @@index([sku])
}

model ProductCategory {
  id          String            @id @default(uuid()) @db.Uuid
  tenantId    String?           @map("tenant_id") @db.Uuid
  parentId    String?           @map("parent_id") @db.Uuid
  name        String
  description String?
  createdAt   DateTime?         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime?         @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant      Tenant?           @relation(fields: [tenantId], references: [id])
  parent      ProductCategory?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  children    ProductCategory[] @relation("CategoryToCategory")
  products    Product[]

  @@index([tenantId])
  @@index([parentId])
}

// =========================================================
//  FINANCIALS & LOGGING
// =========================================================

model ExpenseCategory {
  id        String    @id @default(uuid()) @db.Uuid
  tenantId  String    @map("tenant_id") @db.Uuid
  name      String
  code      String
  isPrivate Boolean?  @default(false) @map("is_private")
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  expenses  Expense[]

  @@index([tenantId])
  @@index([code])
}

model Expense {
  id                String          @id @default(uuid()) @db.Uuid
  isShow            Boolean         @default(true) @map("is_show")
  tenantId          String          @map("tenant_id") @db.Uuid
  expenseCategoryId String          @map("expense_category_id") @db.Uuid
  staffId           String          @map("staff_id") @db.Uuid
  description       String
  amount            Decimal
  paidAt            DateTime?       @map("paid_at") @db.Timestamptz(6)
  attachmentUrl     String?         @map("attachment_url")
  createdAt         DateTime?       @default(now()) @map("created_at") @db.Timestamptz(6)
  paymentType       String          @default("Cash") @map("payment_type")
  tenant            Tenant          @relation(fields: [tenantId], references: [id])
  expenseCategory   ExpenseCategory @relation(fields: [expenseCategoryId], references: [id])
  staff             Staff           @relation(fields: [staffId], references: [id])
  payrollDetailId   String?         @map("payroll_detail_id") @db.Uuid
  payrollDetail     PayrollDetail?  @relation(fields: [payrollDetailId], references: [id])

  @@index([tenantId])
  @@index([expenseCategoryId])
  @@index([staffId])
  @@index([createdAt])
}

model Log {
  id        String   @id @default(uuid()) @db.Uuid
  staffId   String?  @map("staff_id") @db.Uuid
  tenantId  String?  @default(uuid()) @map("tenant_id") @db.Uuid
  action    String?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  data      Json?
  staff     Staff?   @relation(fields: [staffId], references: [id])
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([staffId])
  @@index([createdAt])
}

// =========================================================
//  SUBSCRIPTION & SETTINGS
// =========================================================

model TenantSetting {
  id           BigInt    @id @default(autoincrement())
  tenantId     String    @unique @map("tenant_id") @db.Uuid
  showDiscount Boolean   @default(false) @map("show_discount")
  showTax      Boolean   @default(false) @map("show_tax")
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  tenant       Tenant    @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}

model SubscriptionPlan {
  id            String   @id @default(uuid()) @db.Uuid
  name          String   @unique
  description   String?
  pricePerMonth Decimal  @map("price_per_month")
  pricePerYear  Decimal? @map("price_per_year")
  isBetaTest    Boolean  @default(false) @map("is_beta_test")
  createdAt     DateTime @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @db.Timestamptz(6)
  customLimits  Json?    @map("custom_limits")

  tenantSubscriptions         TenantSubscription[]
  tenantSubscriptionHistories TenantSubscriptionHistory[]

  @@index([name])
}

model TenantSubscription {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @unique @map("tenant_id") @db.Uuid
  planId    String   @map("plan_id") @db.Uuid
  startDate DateTime @default(now()) @map("start_date") @db.Timestamptz(6)
  endDate   DateTime @map("end_date") @db.Timestamptz(6)
  status    String   @default("trial")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  customLimits Json? @map("custom_limits")

  tenant           Tenant           @relation(fields: [tenantId], references: [id])
  subscriptionPlan SubscriptionPlan @relation(fields: [planId], references: [id])

  @@index([tenantId])
  @@index([planId])
  @@index([status])
}

model TenantSubscriptionHistory {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  planId    String   @map("plan_id") @db.Uuid
  startDate DateTime @map("start_date") @db.Timestamptz(6)
  endDate   DateTime @map("end_date") @db.Timestamptz(6)
  status    String   @default("expired")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  snapToken String?  @map("snap_token")

  customLimits Json? @map("custom_limits")

  tenant               Tenant                @relation(fields: [tenantId], references: [id])
  subscriptionPlan     SubscriptionPlan      @relation(fields: [planId], references: [id])
  subscriptionPayments SubscriptionPayment[]

  @@index([tenantId])
  @@index([planId])
  @@index([status])
}

model SubscriptionPayment {
  id                          String   @id @default(uuid()) @db.Uuid
  tenantId                    String   @map("tenant_id") @db.Uuid
  tenantSubscriptionHistoryId String   @map("tenant_subscription_history_id") @db.Uuid
  midtransOrderId             String   @unique @map("midtrans_order_id")
  amount                      Decimal
  paymentMethod               String?  @map("payment_method")
  transactionStatus           String   @map("transaction_status")
  createdAt                   DateTime @default(now()) @db.Timestamptz(6)

  tenantSubscriptionHistory TenantSubscriptionHistory @relation(fields: [tenantSubscriptionHistoryId], references: [id])
  tenant                    Tenant                    @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([tenantSubscriptionHistoryId])
  @@index([transactionStatus])
}

// =========================================================
//  PAYROLL & HR MANAGEMENT
// =========================================================

enum LeaveType {
  SICK // Sakit
  LEAVE // Cuti
  PERMIT // Izin
  ABSENT // Alpha/tidak hadir tanpa keterangan
  OTHER // Lainnya
}

enum SalaryType {
  MONTHLY
  HOURLY
}

enum OvertimeCalculationType {
  HOURLY
  MONTHLY
}

model PayrollSetting {
  id                      String                  @id @default(uuid()) @db.Uuid
  tenantId                String                  @unique @map("tenant_id") @db.Uuid
  ump                     Decimal?                @map("ump")
  normalWorkHoursPerDay   Int?                    @default(7) @map("normal_work_hours_per_day")
  normalWorkHoursPerMonth Int?                    @default(173) @map("normal_work_hours_per_month")
  overtimeRate1           Decimal?                @default(1.5) @map("overtime_rate_1")
  overtimeRate2           Decimal?                @default(2) @map("overtime_rate_2")
  overtimeRateWeekend1    Decimal?                @default(2) @map("overtime_rate_weekend_1")
  overtimeRateWeekend2    Decimal?                @default(3) @map("overtime_rate_weekend_2")
  overtimeRateWeekend3    Decimal?                @default(4) @map("overtime_rate_weekend_3")
  overtimeCalculationType OvertimeCalculationType @default(HOURLY) @map("overtime_calculation_type")
  createdAt               DateTime?               @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime?               @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant                  Tenant                  @relation(fields: [tenantId], references: [id])
}

model Salary {
  id             String     @id @default(uuid()) @db.Uuid
  tenantId       String     @map("tenant_id") @db.Uuid
  staffId        String     @unique @map("staff_id") @db.Uuid
  basicSalary    Decimal    @map("basic_salary")
  fixedAllowance Decimal    @default(0) @map("fixed_allowance")
  createdAt      DateTime?  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime?  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  type           SalaryType @default(MONTHLY) @map("salary_type")
  tenant         Tenant     @relation(fields: [tenantId], references: [id])
  staff          Staff      @relation(fields: [staffId], references: [id])

  @@index([tenantId])
}

model Attendance {
  id           String    @id @default(uuid()) @db.Uuid
  tenantId     String    @map("tenant_id") @db.Uuid
  staffId      String    @map("staff_id") @db.Uuid
  shiftId      String?   @map("shift_id") @db.Uuid
  date         DateTime  @db.Date
  checkInTime  String?   @map("check_in_time")
  checkOutTime String?   @map("check_out_time")
  totalHours   Decimal?  @map("total_hours")
  isWeekend    Boolean?  @default(false) @map("is_weekend")
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime? @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant       Tenant    @relation(fields: [tenantId], references: [id])
  staff        Staff     @relation(fields: [staffId], references: [id])
  shift        Shift?    @relation(fields: [shiftId], references: [id])

  @@index([tenantId])
  @@index([staffId])
  @@index([shiftId])
  @@index([date])
  @@index([tenantId, staffId, date])
}

model PayrollPeriod {
  id             String          @id @default(uuid()) @db.Uuid
  tenantId       String          @map("tenant_id") @db.Uuid
  periodStart    DateTime        @map("period_start") @db.Date
  periodEnd      DateTime        @map("period_end") @db.Date
  isFinalized    Boolean         @default(false) @map("is_finalized")
  createdAt      DateTime?       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime?       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant         Tenant          @relation(fields: [tenantId], references: [id])
  payrollDetails PayrollDetail[]

  @@unique([tenantId, periodStart])
  @@index([tenantId])
}

model PayrollDetail {
  id                   String        @id @default(uuid()) @db.Uuid
  tenantId             String        @map("tenant_id") @db.Uuid
  payrollPeriodId      String        @map("payroll_period_id") @db.Uuid
  staffId              String        @map("staff_id") @db.Uuid
  basicSalaryAmount    Decimal       @map("basic_salary_amount")
  fixedAllowanceAmount Decimal       @map("fixed_allowance_amount")
  overtimeHours        Decimal       @default(0) @map("overtime_hours")
  overtimePay          Decimal       @default(0) @map("overtime_pay")
  bonusAmount          Decimal       @default(0) @map("bonus_amount")
  deductionsAmount     Decimal       @default(0) @map("deductions_amount")
  takeHomePay          Decimal       @map("take_home_pay")
  isPaid               Boolean       @default(false) @map("is_paid")
  paidAt               DateTime?     @map("paid_at") @db.Timestamptz(6)
  createdAt            DateTime?     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime?     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant               Tenant        @relation(fields: [tenantId], references: [id])
  payrollPeriod        PayrollPeriod @relation(fields: [payrollPeriodId], references: [id])
  staff                Staff         @relation(fields: [staffId], references: [id])
  expenses             Expense[]

  @@index([tenantId])
  @@index([payrollPeriodId])
  @@index([staffId])
  @@index([isPaid])
}

model StaffLeave {
  id        String    @id @default(uuid())
  staffId   String    @map("staff_id") @db.Uuid
  staff     Staff     @relation(fields: [staffId], references: [id])
  type      LeaveType
  reason    String?
  startDate DateTime
  endDate   DateTime
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}


// =========================================================
//  NOTIFICATIONS
// =========================================================


// ---------------------------------------------------------
//  ORDER NOTIFICATIONS
// ---------------------------------------------------------

enum NotificationEvent {
  ORDER_CREATED
  ORDER_UPDATED
  ORDER_PAID
  ORDER_COMPLETED
  ORDER_CANCELLED
  PAYMENT_REMINDER
  CUSTOM
}

model TenantNotificationConfig {
  id                         String   @id @default(uuid())
  tenantId                   String   @unique @map("tenant_id") @db.Uuid
  provider                   String   @default("fonnte") // bisa fonnte, email, dll
  apiToken                   String   @map("api_token")
  apiUrl                     String   @default("https://api.fonnte.com/send") @map("api_url")
  isActive                   Boolean  @default(true) @map("is_active")
  
  // Notification settings per event
  enableOrderCreated         Boolean  @default(true) @map("enable_order_created")
  enableOrderUpdated         Boolean  @default(false) @map("enable_order_updated")
  enableOrderPaid            Boolean  @default(true) @map("enable_order_paid")
  enableOrderCompleted       Boolean  @default(false) @map("enable_order_completed")
  enableOrderCancelled       Boolean  @default(false) @map("enable_order_cancelled")
  
  // Template IDs for each event (optional, will use default if null)
  orderCreatedTemplateId     String?  @map("order_created_template_id") @db.Uuid
  orderUpdatedTemplateId     String?  @map("order_updated_template_id") @db.Uuid
  orderPaidTemplateId        String?  @map("order_paid_template_id") @db.Uuid
  orderCompletedTemplateId   String?  @map("order_completed_template_id") @db.Uuid
  orderCancelledTemplateId   String?  @map("order_cancelled_template_id") @db.Uuid
  
  createdAt                  DateTime @default(now()) @map("created_at")
  updatedAt                  DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])
}

model NotificationTemplate {
  id        String             @id @default(uuid())
  tenantId  String             @map("tenant_id") @db.Uuid
  name      String // contoh: "Order Created", "Order Paid", "Custom Reminder"
  event     NotificationEvent? // optional, jika null berarti custom
  message   String // isi pesan dengan {{variable}}
  isActive  Boolean            @default(true) @map("is_active")
  isCustom  Boolean            @default(false) @map("is_custom")
  createdAt DateTime           @default(now()) @map("created_at")
  updatedAt DateTime           @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([event])
}

model NotificationLog {
  id         String   @id @default(uuid())
  tenantId   String   @map("tenant_id") @db.Uuid
  templateId String?  @map("template_id") @db.Uuid
  recipient  String
  message    String
  status     String // success, failed
  response   Json?
  error      String?
  createdAt  DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([templateId])
  @@index([status])
  @@index([createdAt])
}

// ---------------------------------------------------------
//  REPORT
// ---------------------------------------------------------

model TenantReport {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  type      String // profit_and_loss, sales, expense, dll
  period    String
  title     String
  data      Json // simpan data laporan dalam bentuk JSON
  pdfUrl    String?  @map("pdf_url") // link ke file PDF jika ada
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([type])
  @@index([createdAt])
}

model BannerCampaign {
  id            String   @id @default(uuid()) @db.Uuid
  name          String
  description   String?
  imageUrl      String   @map("image_url")
  isActive      Boolean  @default(false) @map("is_active")
  publishAt     DateTime @map("publish_at")
  publishUntil  DateTime @map("publish_until")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([isActive])
  @@index([publishAt])
  @@index([publishUntil])
}

// =========================================================
//  SHIFT MANAGEMENT
// =========================================================

model Shift {
  id                      String      @id @default(uuid()) @db.Uuid
  tenantId                String      @map("tenant_id") @db.Uuid
  name                    String
  startTime               String      @map("start_time") // Format: "HH:mm"
  endTime                 String      @map("end_time") // Format: "HH:mm"
  isActive                Boolean     @default(true) @map("is_active")
  calculateBeforeStartTime Boolean    @default(true) @map("calculate_before_start_time")
  hasBreakTime            Boolean     @default(false) @map("has_break_time")
  breakDuration           Int         @default(0) @map("break_duration") // in minutes
  minWorkingHours         Float       @default(8) @map("min_working_hours")
  maxWorkingHours         Float       @default(8) @map("max_working_hours")
  overtimeMultiplier      Float       @default(1.5) @map("overtime_multiplier")
  lateThreshold           Int         @default(15) @map("late_threshold") // in minutes
  earlyCheckInAllowed     Int         @default(30) @map("early_checkin_allowed") // in minutes
  color                   String      @default("#3B82F6")
  description             String?
  createdAt               DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime    @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  // Relations
  tenant                  Tenant      @relation(fields: [tenantId], references: [id])
  staffShifts             StaffShift[]
  attendances             Attendance[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([isActive])
  @@index([startTime])
}

model StaffShift {
  id                  String    @id @default(uuid()) @db.Uuid
  tenantId            String    @map("tenant_id") @db.Uuid
  staffId             String    @map("staff_id") @db.Uuid
  shiftId             String    @map("shift_id") @db.Uuid
  date                DateTime  @db.Date
  checkInTime         String?   @map("check_in_time") // Format: "HH:mm"
  checkOutTime        String?   @map("check_out_time") // Format: "HH:mm"
  actualBreakDuration Int?      @map("actual_break_duration") // in minutes
  totalWorkedMinutes  Int?      @map("total_worked_minutes")
  lateMinutes         Int       @default(0) @map("late_minutes")
  overtimeMinutes     Int       @default(0) @map("overtime_minutes")
  isCompleted         Boolean   @default(false) @map("is_completed")
  notes               String?
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  // Relations
  tenant              Tenant    @relation(fields: [tenantId], references: [id])
  staff               Staff     @relation(fields: [staffId], references: [id])
  shift               Shift     @relation(fields: [shiftId], references: [id])

  @@unique([tenantId, staffId, shiftId, date])
  @@index([tenantId])
  @@index([staffId])
  @@index([shiftId])
  @@index([date])
  @@index([isCompleted])
}

// =========================================================
//  REPORT MANAGEMENT
// =========================================================

model Report {
  id          String       @id @default(uuid()) @db.Uuid
  tenantId    String       @map("tenant_id") @db.Uuid
  type        ReportType
  startDate   DateTime     @map("start_date") @db.Timestamptz(6)
  endDate     DateTime     @map("end_date") @db.Timestamptz(6)
  status      ReportStatus @default(PENDING)
  pdfUrl      String?      @map("pdf_url")
  s3Key       String?      @map("s3_key")
  data        Json         @default("{}")
  error       String?
  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime     @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([type])
  @@index([status])
  @@index([tenantId, type, startDate, endDate])
  @@index([createdAt])
}

enum ReportType {
  SALES
  PROFIT_LOSS
}

enum ReportStatus {
  PENDING
  GENERATED
  FAILED
}

// =========================================================
//  DONATION MANAGEMENT
// =========================================================

enum DonationStatus {
  PENDING
  PAID
  FAILED
  EXPIRED
}

model DonationPaymentMethod {
  id               String           @id @default(uuid()) @db.Uuid
  name             String           @unique // e.g., "BCA Virtual Account", "GoPay", "QRIS"
  code             String           @unique // Midtrans payment code: "bca_va", "gopay", "qris"
  type             String           // "bank_transfer", "ewallet", "qris"
  transactionFee   Decimal          @map("transaction_fee") @db.Decimal(15, 2) // Fixed fee amount in IDR
  feePercentage    Decimal?         @map("fee_percentage") @db.Decimal(5, 2) // Optional percentage fee (e.g., 2% for GoPay)
  taxPercentage    Decimal?         @map("tax_percentage") @db.Decimal(5, 2) // Optional tax/PPN percentage (e.g., 11% for PPN)
  minAmount        Decimal          @map("min_amount") @db.Decimal(15, 2) // Minimum transaction amount
  maxAmount        Decimal?         @map("max_amount") @db.Decimal(15, 2) // Optional maximum amount
  isActive         Boolean          @default(true) @map("is_active")
  iconUrl          String?          @map("icon_url")
  description      String?
  displayOrder     Int              @default(0) @map("display_order")
  createdAt        DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime         @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  donations        TenantDonation[]

  @@index([isActive])
  @@index([type])
  @@index([displayOrder])
}

model TenantDonation {
  id                    String                  @id @default(uuid()) @db.Uuid
  tenantId              String                  @map("tenant_id") @db.Uuid
  paymentMethodId       String?                 @map("payment_method_id") @db.Uuid
  midtransOrderId       String                  @unique @map("midtrans_order_id")
  snapToken             String?                 @map("snap_token")
  amount                Decimal                 @db.Decimal(15, 2)
  transactionFee        Decimal                 @default(0) @map("transaction_fee") @db.Decimal(15, 2)
  netAmount             Decimal                 @map("net_amount") @db.Decimal(15, 2) // amount - transactionFee
  status                DonationStatus          @default(PENDING)
  paymentType           String?                 @map("payment_type") // From Midtrans webhook
  transactionTime       DateTime?               @map("transaction_time") @db.Timestamptz(6)
  settlementTime        DateTime?               @map("settlement_time") @db.Timestamptz(6)
  expiryTime            DateTime?               @map("expiry_time") @db.Timestamptz(6)
  message               String?                 // Optional message from tenant
  midtransResponse      Json?                   @map("midtrans_response") // Store full webhook response
  createdAt             DateTime                @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime                @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  tenant                Tenant                  @relation(fields: [tenantId], references: [id])
  paymentMethod         DonationPaymentMethod?  @relation(fields: [paymentMethodId], references: [id])
  commissions           HunterCommission[]
  systemLedgers         SystemLedger[]

  @@index([tenantId])
  @@index([status])
  @@index([createdAt])
  @@index([tenantId, createdAt])
  @@index([tenantId, status])
  @@index([settlementTime])
}

// ---------------------------------------------------------
//  PUSH NOTIFICATION (FCM)
// ---------------------------------------------------------

model PushNotificationToken {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  userId     String?  @map("user_id") @db.Uuid // nullable for staff tokens
  staffId    String?  @map("staff_id") @db.Uuid // nullable for owner tokens
  fcmToken   String   @map("fcm_token") @db.Text
  deviceType String?  @map("device_type") // ios, android, web
  deviceId   String?  @map("device_id")
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  lastUsedAt DateTime @default(now()) @map("last_used_at") @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User?  @relation(fields: [userId], references: [id])
  staff  Staff? @relation(fields: [staffId], references: [id])

  @@unique([fcmToken])
  @@index([tenantId])
  @@index([userId])
  @@index([staffId])
  @@index([isActive])
}

model PushNotificationMessage {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  title       String
  body        String   @db.Text
  data        Json?    // additional payload data
  imageUrl    String?  @map("image_url")
  
  // Targeting options
  targetType  String   @map("target_type") // token, topic, condition, broadcast
  targetValue String?  @map("target_value") @db.Text // FCM token, topic name, or condition
  
  // Notification category
  category    String? // donation, order, payment, system, custom
  eventType   String?  @map("event_type") // donation_pending, donation_completed, etc
  
  // Delivery status
  status      String   @default("pending") // pending, sent, failed
  sentAt      DateTime? @map("sent_at") @db.Timestamptz(6)
  failedAt    DateTime? @map("failed_at") @db.Timestamptz(6)
  
  // FCM response
  fcmResponse Json?    @map("fcm_response")
  error       String?  @db.Text
  
  // Retry logic
  retryCount  Int      @default(0) @map("retry_count")
  maxRetries  Int      @default(3) @map("max_retries")
  
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([status])
  @@index([category])
  @@index([eventType])
  @@index([createdAt])
  @@index([tenantId, status])
  @@index([tenantId, category])
}

model PushNotificationSubscription {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  tokenId   String   @map("token_id") @db.Uuid
  topic     String   // e.g., "donations", "orders", "all_owners"
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([tokenId, topic])
  @@index([tenantId])
  @@index([topic])
  @@index([isActive])
}

// =========================================================
//  HUNTER / AFFILIATE SYSTEM
// =========================================================

model Hunter {
  id                    String              @id @default(uuid()) @db.Uuid
  userId                String?             @unique @map("user_id") @db.Uuid // Optional: Hunter can be a registered user
  adminId               String              @map("admin_id") @db.Uuid // Admin who created this hunter
  referralCode          String              @unique @map("referral_code") // Unique referral code
  name                  String              // Hunter full name
  email                 String              @unique
  phone                 String?
  commissionPercentage  Decimal             @default(10) @map("commission_percentage") @db.Decimal(5, 2) // Percentage of donation amount
  isActive              Boolean             @default(true) @map("is_active")
  totalEarnings         Decimal             @default(0) @map("total_earnings") @db.Decimal(15, 2) // Cumulative earnings
  totalPaidOut          Decimal             @default(0) @map("total_paid_out") @db.Decimal(15, 2) // Total amount paid to hunter
  bankAccountName       String?             @map("bank_account_name")
  bankAccountNumber     String?             @map("bank_account_number")
  bankName              String?             @map("bank_name")
  notes                 String?             @db.Text
  createdAt             DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  user                  User?               @relation(fields: [userId], references: [id])
  admin                 Admin               @relation(fields: [adminId], references: [id])
  tenants               Tenant[]            // Tenants referred by this hunter
  commissions           HunterCommission[]
  payouts               HunterPayout[]
  systemLedgers         SystemLedger[]      @relation("HunterLedgers")

  @@index([referralCode])
  @@index([isActive])
  @@index([adminId])
  @@index([email])
}

model HunterCommission {
  id                String                @id @default(uuid()) @db.Uuid
  hunterId          String                @map("hunter_id") @db.Uuid
  tenantId          String                @map("tenant_id") @db.Uuid
  donationId        String                @map("donation_id") @db.Uuid
  donationAmount    Decimal               @map("donation_amount") @db.Decimal(15, 2) // Net amount after transaction fees
  commissionRate    Decimal               @map("commission_rate") @db.Decimal(5, 2) // Commission percentage at time of calculation
  commissionAmount  Decimal               @map("commission_amount") @db.Decimal(15, 2) // Calculated commission
  status            CommissionStatus      @default(PENDING)
  paidOutAt         DateTime?             @map("paid_out_at") @db.Timestamptz(6)
  notes             String?               @db.Text
  createdAt         DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime              @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  hunter            Hunter                @relation(fields: [hunterId], references: [id])
  donation          TenantDonation        @relation(fields: [donationId], references: [id])
  systemLedgers     SystemLedger[]        @relation("CommissionLedgers")

  @@index([hunterId])
  @@index([tenantId])
  @@index([donationId])
  @@index([status])
  @@index([createdAt])
  @@index([hunterId, status])
}

model HunterPayout {
  id                String           @id @default(uuid()) @db.Uuid
  hunterId          String           @map("hunter_id") @db.Uuid
  amount            Decimal          @db.Decimal(15, 2)
  paymentMethod     String?          @map("payment_method") // bank_transfer, cash, etc
  referenceNumber   String?          @map("reference_number") // Bank transaction reference
  status            PayoutStatus     @default(PENDING)
  processedBy       String?          @map("processed_by") @db.Uuid // Admin ID who processed
  processedAt       DateTime?        @map("processed_at") @db.Timestamptz(6)
  notes             String?          @db.Text
  createdAt         DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  hunter            Hunter           @relation(fields: [hunterId], references: [id])
  systemLedgers     SystemLedger[]   @relation("PayoutLedgers")

  @@index([hunterId])
  @@index([status])
  @@index([createdAt])
}

model SystemLedger {
  id                String              @id @default(uuid()) @db.Uuid
  transactionType   TransactionType     @map("transaction_type")
  category          LedgerCategory
  amount            Decimal             @db.Decimal(15, 2)
  balance           Decimal             @db.Decimal(15, 2) // Running balance after this transaction
  description       String              @db.Text
  referenceType     String?             @map("reference_type") // donation, commission, payout, subscription, etc
  referenceId       String?             @map("reference_id") @db.Uuid
  hunterId          String?             @map("hunter_id") @db.Uuid
  tenantId          String?             @map("tenant_id") @db.Uuid
  donationId        String?             @map("donation_id") @db.Uuid
  commissionId      String?             @map("commission_id") @db.Uuid
  payoutId          String?             @map("payout_id") @db.Uuid
  metadata          Json?               // Additional data
  createdAt         DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  
  hunter            Hunter?             @relation("HunterLedgers", fields: [hunterId], references: [id])
  donation          TenantDonation?     @relation(fields: [donationId], references: [id])
  commission        HunterCommission?   @relation("CommissionLedgers", fields: [commissionId], references: [id])
  payout            HunterPayout?       @relation("PayoutLedgers", fields: [payoutId], references: [id])

  @@index([transactionType])
  @@index([category])
  @@index([hunterId])
  @@index([tenantId])
  @@index([donationId])
  @@index([commissionId])
  @@index([payoutId])
  @@index([createdAt])
  @@index([referenceType, referenceId])
}

enum CommissionStatus {
  PENDING       // Commission calculated but not paid
  APPROVED      // Approved for payout
  PAID          // Commission paid to hunter
  CANCELLED     // Commission cancelled (e.g., refund)
}

enum PayoutStatus {
  PENDING       // Payout requested
  PROCESSING    // Being processed
  COMPLETED     // Successfully paid
  FAILED        // Payment failed
  CANCELLED     // Payout cancelled
}

enum TransactionType {
  DEBIT         // Money out from system
  CREDIT        // Money in to system
}

enum LedgerCategory {
  DONATION_RECEIVED         // System receives donation from tenant
  DONATION_REFUND          // Refund donation to tenant
  COMMISSION_CALCULATED     // Commission calculated for hunter
  COMMISSION_PAID          // Commission paid to hunter
  SUBSCRIPTION_RECEIVED     // Subscription payment received
  PLATFORM_FEE             // Platform fees
  PAYMENT_GATEWAY_FEE      // Payment gateway transaction fees
  PAYOUT_TO_HUNTER         // Money paid to hunter
  OTHER_INCOME             // Other income
  OTHER_EXPENSE            // Other expenses
}
